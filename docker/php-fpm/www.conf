pm = dynamic

[www]
; NOME DO POOL
; Nome único deste pool. Usado em logs e estatísticas.
user = www-data
group = www-data
listen = 9000

; Parâmetros do socket Unix
; Não usado quando listen está configurado para endereço TCP
listen.backlog = 65535
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; === GERENCIADOR DE PROCESSOS ===
; Valores válidos: static, dynamic, ondemand
; static: Número fixo de processos filhos
; dynamic: Cria/remove filhos dinamicamente
; ondemand: Só cria filhos quando chegam requisições



; === MODO STATIC (descomente para usar)
; pm.max_children = 50

; === MODO DYNAMIC (atual)
; Número máximo de processos filhos ativos ao mesmo tempo
pm.max_children = 50

; Número inicial de processos servidores ociosos
pm.start_servers = 10

; Número mínimo de processos servidores ociosos
pm.min_spare_servers = 5

; Número máximo de processos servidores ociosos
pm.max_spare_servers = 20

; Número de requisições que cada processo filho deve tratar antes de ser reiniciado
pm.max_requests = 500

; Tempo limite para processos ociosos (segundos)
pm.process_idle_timeout = 30s

; === LOGS ===
; Tokens disponíveis:
; %C = Endereço do cliente (IP)
; %d = Duração da requisição (microssegundos)
; %e = Erros (PHP_FE_EXEC, PHP_FE_LOG, etc)
; %f = Nome do arquivo do script
; %l = Tamanho do conteúdo da requisição (POST)
; %m = Método da requisição
; %M = Uso de memória
; %n = Nome do pool
; %o = Tamanho da saída
; %p = PID
; %P = PID do pai
; %q = Query string
; %Q = "?" se existe query string
; %r = URI da requisição (original)
; %R = Usuário remoto
; %s = Código de status
; %T = Tempo de execução (segundos)
; %t = Timestamp (iso 8601)
; %u = Usuário remoto

; Formato do log de acesso
access.format = "[%t] %C:{remote}p \"%m %r\" %s %{milli}dms %{kilobytes}k %M"

; Arquivo de log de acessos
; access.log = /var/log/php-fpm/access.log

; Arquivo de log de erros do PHP
php_admin_value[error_log] = /var/log/php-fpm/error.log
php_admin_value[log_errors] = on

; === PERFORMANCE ===
; Habilitar opcache para produção
php_value[opcache.enable] = 1
php_value[opcache.enable_cli] = 0
php_value[opcache.memory_consumption] = 128
php_value[opcache.interned_strings_buffer] = 16
php_value[opcache.max_accelerated_files] = 10000
php_value[opcache.validate_timestamps] = 0
php_value[opcache.save_comments] = 0
php_value[opcache.jit_buffer_size] = 64M
php_value[opcache.jit] = 1255

; === LIMITES ===
; Tempo máximo de execução de um script (segundos)
php_value[max_execution_time] = 30

; Quantidade máxima de memória que um script pode consumir
php_value[memory_limit] = 256M

; Tamanho máximo de upload de arquivo
php_value[upload_max_filesize] = 100M
php_value[post_max_size] = 100M

; Número máximo de arquivos em uma requisição
php_value[max_file_uploads] = 20

; === BANCO DE DADOS ===
php_value[pdo_mysql.default_socket] = /var/run/mysqld/mysqld.sock

; === MONITORAMENTO ===
; Página de status (requer acesso ao pm.status_path)
; Descomente para habilitar: GET /php-status para ver métricas
; pm.status_path = /php-status

; endpoint de ping para health checks
; ping.path = /ping
; ping.response = pong

; === TRATAMENTO DE ERROS ===
; Exibir erros apenas em desenvolvimento
php_admin_value[display_errors] = off

; Logar todos os erros do PHP
php_value[log_errors] = on
php_value[error_log] = /var/log/php-fpm/error.log
php_value[error_reporting] = E_ALL & ~E_DEPRECATED & ~E_STRICT

; === SEGURANÇA ===
; Desabilitar funções perigosas
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source

; Restringir acesso a arquivos
php_admin_flag[expose_php] = off

; === DEBUG DE DESENVOLVIMENTO (comente em produção) ===
; Descomente para desenvolvimento:
; php_value[xdebug.mode] = develop
; php_value[xdebug.client_host] = host.docker.internal
; php_value[xdebug.client_port] = 9003

; Máximo de processos ociosos
pm.max_spare_servers = 3

; Número máximo de requisições que cada processo filho deve executar antes de ser reiniciado
; Ajuda a prevenir memory leaks
pm.max_requests = 500

; Timeout para processamento de requisições (em segundos)
request_terminate_timeout = 30

; Configuração de log
catch_workers_output = yes
php_admin_value[error_log] = /var/log/php-fpm/error.log
php_admin_flag[log_errors] = on
