[www]
; ============================================
; NOME DO POOL
; ============================================
; Nome único deste pool. Usado em logs e estatísticas.
user = www-data
group = www-data
listen = 9000

; Parâmetros do socket Unix
; Não usado quando listen está configurado para endereço TCP
listen.backlog = 65535
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; ============================================
; GERENCIADOR DE PROCESSOS
; ============================================
; Valores válidos: static, dynamic, ondemand
; static: Número fixo de processos filhos
; dynamic: Cria/remove filhos dinamicamente (RECOMENDADO)
; ondemand: Só cria filhos quando chegam requisições
pm = dynamic

; Número máximo de processos filhos ativos ao mesmo tempo
; Fórmula: (RAM disponível) / (RAM por processo) = 512MB / 10MB = 50
pm.max_children = 50

; Número inicial de processos servidores ao iniciar
pm.start_servers = 10

; Número mínimo de processos ociosos (prontos para requisições)
pm.min_spare_servers = 5

; Número máximo de processos ociosos (economia de memória)
pm.max_spare_servers = 20

; Número de requisições antes de reiniciar processo (evita memory leak)
pm.max_requests = 500

; Tempo limite para processos ociosos (segundos)
pm.process_idle_timeout = 30s

; ============================================
; LOGS
; ============================================
; Capturar saída dos workers (stdout/stderr)
catch_workers_output = yes
decorate_workers_output = no

; Formato do log de acesso
; Tokens: %C=IP, %m=Método, %r=URI, %s=Status, %d=Duração, %M=Memória
access.format = "[%t] %C \"%m %r\" %s %{milli}dms %{kilo}Mb"

; Arquivo de log de erros do PHP
php_admin_value[error_log] = /var/log/php-fpm/error.log
php_admin_flag[log_errors] = on

; ============================================
; PERFORMANCE - OPCACHE
; ============================================
; Habilitar opcache para produção (cache de bytecode)
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.enable_cli] = 0
php_admin_value[opcache.memory_consumption] = 128
php_admin_value[opcache.interned_strings_buffer] = 16
php_admin_value[opcache.max_accelerated_files] = 10000
; Em produção: 0 (não verifica mudanças nos arquivos)
php_admin_value[opcache.validate_timestamps] = 0
; Manter comentários para anotações do Laravel
php_admin_value[opcache.save_comments] = 1
; JIT (Just-In-Time) Compiler - PHP 8+
php_admin_value[opcache.jit_buffer_size] = 64M
php_admin_value[opcache.jit] = 1255

; ============================================
; LIMITES DE RECURSOS
; ============================================
; Tempo máximo de execução de um script (segundos)
php_admin_value[max_execution_time] = 30

; Quantidade máxima de memória que um script pode consumir
php_admin_value[memory_limit] = 128M

; Tamanho máximo de upload de arquivo
php_admin_value[upload_max_filesize] = 100M
php_admin_value[post_max_size] = 100M

; Número máximo de arquivos em uma requisição
php_admin_value[max_file_uploads] = 20

; ============================================
; BANCO DE DADOS
; ============================================
php_admin_value[pdo_mysql.default_socket] = /var/run/mysqld/mysqld.sock

; ============================================
; MONITORAMENTO
; ============================================
; Página de status do PHP-FPM (GET /php-fpm-status)
pm.status_path = /php-fpm-status

; Endpoint de ping para health checks (GET /php-fpm-ping)
ping.path = /php-fpm-ping
ping.response = pong

; ============================================
; TIMEOUTS
; ============================================
; Tempo máximo para processar uma requisição (segundos)
request_terminate_timeout = 30

; Tempo para considerar processo lento (para logs)
request_slowlog_timeout = 5s
slowlog = /proc/self/fd/2

; ============================================
; TRATAMENTO DE ERROS
; ============================================
; Não exibir erros na resposta (segurança em produção)
php_admin_value[display_errors] = off
php_admin_value[display_startup_errors] = off

; Logar todos os erros do PHP
php_admin_value[error_reporting] = E_ALL & ~E_DEPRECATED & ~E_STRICT

; ============================================
; SEGURANÇA
; ============================================
; Desabilitar funções perigosas
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,parse_ini_file,show_source

; Não expor versão do PHP nos headers
php_admin_flag[expose_php] = off

; ============================================
; REALPATH CACHE (PERFORMANCE)
; ============================================
; Cache para resolução de caminhos de arquivos
php_admin_value[realpath_cache_size] = 4096K
php_admin_value[realpath_cache_ttl] = 600
